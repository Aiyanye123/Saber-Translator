**1.1. 更新常量 (`src/shared/constants.py`)**

*   **文件路径:** `src/shared/constants.py`
*   **修改内容:** 在 `SUPPORTED_AI_VISION_PROVIDERS` 字典中添加新的服务商条目。定义一个新的常量 `CUSTOM_AI_VISION_PROVIDER_ID`。

*   **代码演示:**
    ```python
    # src/shared/constants.py
    
    # ... (文件顶部的其他 import 和常量) ...
    
    # --- AI 视觉 OCR 相关 ---
    AI_VISION_OCR_ENGINE_ID = 'ai_vision'  # 定义唯一标识符
    
    # 新增自定义OpenAI兼容服务商ID (确保这个值是唯一的)
    CUSTOM_AI_VISION_PROVIDER_ID = 'custom_openai_vision' # 与翻译的自定义ID区分
    
    DEFAULT_AI_VISION_OCR_PROMPT = """你是一个ocr助手，你需要将我发送给你的图片中的文字提取出来并返回给我，要求：
    1、完整识别：我发送给你的图片中的文字都是需要识别的内容
    2、非贪婪输出：不要返回任何其他解释和说明。"""
    
    SUPPORTED_AI_VISION_PROVIDERS = {
        'siliconflow': 'SiliconFlow (硅基流动)',
        'volcano': '火山引擎',
        'gemini': 'Google Gemini',
        CUSTOM_AI_VISION_PROVIDER_ID: '自定义 OpenAI 兼容视觉服务' # <<< 新增此行
    }
    
    # ... (文件底部的其他常量) ...
    ```

---

**1.2. 更新前端常量 (`src/app/static/js/constants.js`)**

*   **文件路径:** `src/app/static/js/constants.js`
*   **修改内容:** （可选，但推荐）添加与后端对应的自定义服务商 ID。

*   **代码演示:**
    ```javascript
    // src/app/static/js/constants.js
    
    // ... (文件顶部的其他常量) ...
    
    // 新增 AI 视觉 OCR 默认提示词 (如果之前没有，这是示例位置)
    // export const DEFAULT_AI_VISION_OCR_PROMPT = `...`;
    
    // --- 新增：自定义 AI 视觉 OCR 服务商 ID (前端使用) ---
    export const CUSTOM_AI_VISION_PROVIDER_ID_FRONTEND = 'custom_openai_vision'; // <<< 新增此行
    // ----------------------------------------------------
    
    // ... (文件底部的其他常量) ...
    ```
    *注：如果前端的下拉列表是完全由后端动态生成的，或者直接在 HTML 中使用了后端常量，那么这个前端常量可能不是严格必需的。但如果 JS 逻辑中需要硬编码判断此服务商，则推荐定义。*

---

**1.3. 更新前端 HTML 模板 (`src/app/templates/index.html`)**

*   **文件路径:** `src/app/templates/index.html`
*   **修改内容:**
    1.  在 AI 视觉 OCR 服务商的 `<select id="aiVisionProvider">` 下拉列表中，添加一个新的 `<option>`。
    2.  在该下拉列表下方，添加一个新的 `<div>` 容器，用于放置自定义 Base URL 的输入框，并将其初始 `style` 设置为 `display: none;`。

*   **代码演示:**
    找到 `#aiVisionOcrOptions` `div` 内部的 `#aiVisionProvider` `<select>` 元素，并进行如下修改：

    ```html
    <!-- src/app/templates/index.html -->
    
    <!-- ... (省略部分 HTML) ... -->
                            <div id="aiVisionOcrOptions" style="display: none;">
                                <div>
                                    <label for="aiVisionProvider">服务商:</label>
                                    <select id="aiVisionProvider">
                                        <option value="siliconflow" selected>SiliconFlow (硅基流动)</option>
                                        <option value="volcano">火山引擎</option>
                                        <option value="gemini">Google Gemini</option>
                                        <!-- VVVVVV 新增的选项 VVVVVV -->
                                        <option value="{{ constants.CUSTOM_AI_VISION_PROVIDER_ID }}">自定义 OpenAI 兼容视觉服务</option>
                                        <!-- ^^^^^^ 使用后端常量生成 value ^^^^^^ -->
                                    </select>
                                </div>
                                <!-- VVVVVV 新增的 Base URL 输入区域 VVVVVV -->
                                <div id="customAiVisionBaseUrlDiv" style="display: none;">
                                    <label for="customAiVisionBaseUrl">Base URL (视觉服务):</label>
                                    <input type="text" id="customAiVisionBaseUrl" placeholder="例如: https://api.example.com/v1">
                                    <div class="input-hint">请输入 OpenAI 兼容视觉 API 的基础 URL。</div>
                                </div>
                                <!-- ^^^^^^ 结束新增的 Base URL 输入区域 ^^^^^^ -->
                                <div>
                                    <label for="aiVisionApiKey">API Key:</label>
                                    <input type="text" id="aiVisionApiKey" placeholder="请输入API Key">
                                </div>
                                <!-- ... (后续 aiVisionModelName, aiVisionOcrPrompt, rpdAiVisionOcr, testAiVisionOcrButton 等保持不变) ... -->
                            </div>
    <!-- ... (省略部分 HTML) ... -->
    ```
    *确保 `constants.CUSTOM_AI_VISION_PROVIDER_ID` 能够被 Jinja2 模板正确访问。如果 `constants` 对象没有直接传递给 `index.html` 的渲染上下文，您可能需要在 `src/app/routes.py` 的 `index()` 路由函数中将其加入到 `render_template` 的参数中，或者直接在模板中硬编码 `'custom_openai_vision'` 作为 `value`。但使用后端常量传递是更规范的做法。*

    如果 `constants` 没有传递到模板，可以直接这样写：
    ```html
    <option value="custom_openai_vision">自定义 OpenAI 兼容视觉服务</option>
    ```

---

**1.4. 更新前端状态管理 (`src/app/static/js/state.js`)**

*   **文件路径:** `src/app/static/js/state.js`
*   **修改内容:**
    1.  在文件顶部（或其他合适的位置）添加一个新的 `export let` 变量来存储用户输入的自定义 Base URL。
    2.  添加一个 `export function` 来设置这个新的状态变量。

*   **代码演示:**
    ```javascript
    // src/app/static/js/state.js
    
    // ... (文件顶部的其他 import 和状态变量) ...
    export let aiVisionOcrPrompt = constants.DEFAULT_AI_VISION_OCR_PROMPT;
    export let defaultAiVisionOcrJsonPrompt = constants.DEFAULT_AI_VISION_OCR_JSON_PROMPT;
    export let isAiVisionOcrJsonMode = false;
    
    // VVVVVV 新增状态变量 VVVVVV
    export let customAiVisionBaseUrl = ''; // 用于存储自定义AI视觉服务的Base URL
    // ^^^^^^ 结束新增状态变量 ^^^^^^
    
    // --- RPD 状态 ---
    // ... (RPD 状态变量) ...
    
    // --- 更新状态的函数 ---
    // ... (已有的 setter 函数) ...
    
    // VVVVVV 新增 setter 函数 VVVVVV
    /**
     * 设置自定义AI视觉服务的Base URL
     * @param {string} url - Base URL
     */
    export function setCustomAiVisionBaseUrl(url) {
        customAiVisionBaseUrl = url;
        console.log(`状态更新: 自定义AI视觉Base URL -> ${url}`);
    }
    // ^^^^^^ 结束新增 setter 函数 ^^^^^^
    
    // ... (文件底部的其他函数) ...
    ```

---

**1.5. 更新前端 UI 逻辑 (`src/app/static/js/ui.js`)**

*   **文件路径:** `src/app/static/js/ui.js`
*   **修改内容:** 添加一个新的导出函数，用于根据传入的布尔值来显示或隐藏上面在 HTML 中添加的 `#customAiVisionBaseUrlDiv`。

*   **代码演示:**
    ```javascript
    // src/app/static/js/ui.js
    
    // ... (文件顶部的其他 import 和 UI 函数) ...
    
    // VVVVVV 新增 UI 函数 VVVVVV
    /**
     * 显示或隐藏自定义 AI 视觉 OCR 服务的 Base URL 输入框
     * @param {boolean} show - 是否显示
     */
    export function toggleCustomAiVisionBaseUrlUI(show) {
        const customBaseUrlDiv = $("#customAiVisionBaseUrlDiv"); // 获取元素
        if (show) {
            customBaseUrlDiv.slideDown(); // 使用 jQuery 的 slideDown 动画显示
        } else {
            customBaseUrlDiv.slideUp();   // 使用 jQuery 的 slideUp 动画隐藏
            // 可选：当隐藏时清空输入框内容
            // $('#customAiVisionBaseUrl').val('');
        }
        console.log(`UI 更新: 自定义AI视觉Base URL输入框已 ${show ? '显示' : '隐藏'}`);
    }
    // ^^^^^^ 结束新增 UI 函数 ^^^^^^
    
    // ...
    
    // 可以考虑修改现有的 toggleCustomOpenAiUI 函数（如果用于翻译部分），
    // 使其命名更明确，或者确保它不会与新的 toggleCustomAiVisionBaseUrlUI 冲突。
    // 当前代码中，翻译的自定义 URL 相关的 div id 是 #customBaseUrlDiv，
    // 视觉的我们新加的是 #customAiVisionBaseUrlDiv，所以它们是独立的。
    
    // ... (文件底部的其他 UI 函数) ...
    ```

